{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{# –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ #}
{% block content_title %}{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
    <script src="{% static 'admin/js/jquery.init.js' %}"></script>
    <script src="{% static 'admin/js/core.js' %}"></script>
    <script src="{% static 'admin/js/admin/RelatedObjectLookups.js' %}"></script>
    {{ form.media }}
    
    <style>
        :root {
            --app-primary: #264b5d; 
            --app-accent: #447e9b; 
            --card-bg: #ffffff;
            --text-main: #333;
            --input-bg: #fff;
            --input-border: #ccc;
            --radius: 8px;
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.15);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --card-bg: #2d2d2d;
                --text-main: #e0e0e0;
                --input-bg: #383838;
                --input-border: #555;
            }
        }
        
        body.theme-dark {
            --card-bg: #2d2d2d;
            --text-main: #ffffff;
            --input-bg: #383838;
            --input-border: #555;
        }

        
        #content {
            padding: 0 !important;
            margin: 0 !important;
            width: 100% !important;
        }

        .mgmt-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            padding: 40px 20px;
            box-sizing: border-box;
        }

        .ui-container {
            width: 100%;
            max-width: 550px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border-top: 5px solid var(--app-accent);
            position: relative;
            z-index: 10;
        }

        .ui-header {
            padding: 25px 30px 15px;
            border-bottom: 1px solid rgba(128, 128, 128, 0.1);
        }

        .ui-header h1 {
            margin: 0;
            font-size: 20px;
            color: var(--text-main);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ui-header p {
            margin: 5px 0 0;
            color: #888;
            font-size: 13px;
        }

        .ui-form-body {
            padding: 25px 30px 35px;
        }

        .form-row-custom { margin-bottom: 20px; }
        .form-row-custom.hidden { display: none; }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-main);
            font-size: 14px;
        }

        .ui-select, .ui-input, .ui-textarea {
            width: 100%;
            height: 45px;
            padding: 10px 15px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: var(--radius);
            font-size: 15px;
            color: var(--text-main);
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .ui-select {
            appearance: none; 
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23888888%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 15px top 50%;
            background-size: 12px auto;
            padding-right: 30px;
        }
        
        .ui-textarea { height: auto; min-height: 100px; }

        .ui-select:focus, .ui-input:focus, .ui-textarea:focus {
            border-color: var(--app-accent);
            box-shadow: 0 0 0 2px rgba(68, 126, 155, 0.2);
        }

        .related-widget-wrapper {
            float: none !important;
            overflow: visible !important;
            width: 100%;
        }

        .related-widget-wrapper > div {
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: nowrap !important;
            align-items: stretch !important;
            width: 100%;
            gap: 10px;
        }

        .related-widget-wrapper input {
            flex: 1 1 auto !important;
            width: 1% !important; 
            min-width: 0 !important;
            margin: 0 !important;
            height: 45px !important;
            border-radius: var(--radius) !important;
            border: 1px solid var(--input-border) !important;
            background-color: var(--input-bg) !important;
            color: var(--text-main) !important;
            padding: 10px 15px !important;
            display: block !important;
        }

        .related-lookup {
            flex: 0 0 45px !important;
            width: 45px !important;
            height: 45px !important;
            background-color: var(--app-accent) !important;
            border-radius: var(--radius) !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            text-decoration: none;
            border: none;
            padding: 0 !important;
            margin: 0 !important;
            position: static !important;
            float: none !important;
        }
        
        .related-lookup:hover { background-color: var(--app-primary) !important; }

        .related-lookup:after {
            content: 'üîç'; 
            font-size: 18px;
            line-height: 1;
            filter: grayscale(100%) brightness(200%);
            display: block;
        }
        
        .related-lookup img { display: none !important; }

        .switch-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background-color: rgba(128, 128, 128, 0.1);
            border-radius: var(--radius);
            cursor: pointer;
            border: 1px solid transparent;
        }
        .switch-row:hover { border-color: var(--input-border); }

        .ui-toggle { display: none; }

        .slider {
            cursor: pointer;
            text-indent: -9999px;
            width: 46px;
            height: 26px;
            background: #bdc3c7;
            display: block;
            border-radius: 100px;
            position: relative;
            transition: 0.3s;
        }

        .slider:after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 90px;
            transition: 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .ui-toggle:checked + .slider { background: var(--app-accent); }
        .ui-toggle:checked + .slider:after { left: calc(100% - 3px); transform: translateX(-100%); }

        .ui-submit-btn {
            background: linear-gradient(135deg, var(--app-accent) 0%, var(--app-primary) 100%);
            color: #fff;
            width: 100%;
            border: none;
            padding: 15px;
            font-size: 16px;
            font-weight: 700;
            border-radius: var(--radius);
            cursor: pointer;
            margin-top: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .ui-submit-btn:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            transform: translateY(-1px);
        }

        .ui-submit-btn:active { transform: translateY(1px); }
        
        .non-field-errors {
            background-color: rgba(231, 76, 60, 0.1);
            color: #c0392b;
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        @media (max-width: 768px) {
            .mgmt-wrapper {
                padding: 0;
                align-items: stretch;
            }
            
            .ui-container {
                max-width: 100%;
                border-radius: 0;
                box-shadow: none;
                border-top: none;
                min-height: 100vh;
            }
            
            .ui-header, .ui-form-body {
                padding: 20px;
            }
            
            .ui-select, .ui-input, .ui-textarea, .ui-submit-btn {
                height: 50px;
                font-size: 16px;
            }
            
            .related-lookup {
                width: 50px !important;
                height: 50px !important;
                flex: 0 0 50px !important;
            }
            
            .related-widget-wrapper input {
                height: 50px !important;
            }
        }

    </style>
{% endblock %}

{% block content %}
<div class="mgmt-wrapper">
    <div class="ui-container">
        <div class="ui-header">
            <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏</h1>
            <p>–ú–∞—Å—Å–æ–≤–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –¥–Ω–µ–π –∏ —Ä–∞—Å—Å—ã–ª–∫–∏</p>
        </div>

        <div class="ui-form-body">
            <form method="post">
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="non-field-errors">
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                <div class="form-row-custom">
                    <label class="form-label">{{ form.mode.label }}</label>
                    {{ form.mode }}
                    {{ form.mode.errors }}
                </div>

                <div class="form-row-custom hidden" id="row-user">
                    <label class="form-label">{{ form.target_user.label }}</label>
                    <div class="related-widget-wrapper">
                        {{ form.target_user }}
                    </div>
                    <small style="color:#888; margin-top:6px; display:block; font-size: 12px;">
                        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—É–ø—É –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    </small>
                    {{ form.target_user.errors }}
                </div>

                <div class="form-row-custom">
                    <label class="form-label">{{ form.days.label }}</label>
                    {{ form.days }}
                    {{ form.days.errors }}
                </div>

                <div class="form-row-custom">
                    <label class="switch-row" for="{{ form.send_notification.id_for_label }}">
                        <span style="font-weight:700;">{{ form.send_notification.label }}</span>
                        <div style="display: flex; align-items: center;">
                            {{ form.send_notification }}
                            <span class="slider"></span>
                        </div>
                    </label>
                </div>

                <div class="form-row-custom hidden" id="row-text">
                    <label class="form-label">{{ form.notification_text.label }}</label>
                    {{ form.notification_text }}
                    {{ form.notification_text.errors }}
                </div>

                <button type="submit" 
                        class="ui-submit-btn" 
                        onclick="return confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –¥–Ω–µ–π. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')">
                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">
(function($) {
    $(document).ready(function() {
        
        function updateUI() {
            var mode = $('#id_mode').val();
            var notify = $('#id_send_notification').is(':checked');

            if (mode === 'user') {
                $('#row-user').slideDown(200).removeClass('hidden');
            } else {
                $('#row-user').slideUp(200).addClass('hidden');
            }

            if (notify) {
                $('#row-text').slideDown(200).removeClass('hidden');
            } else {
                $('#row-text').slideUp(200).addClass('hidden');
            }
        }

        $('#id_mode').change(updateUI);
        $('#id_send_notification').change(updateUI);
        
        updateUI();
    });
})(django.jQuery);
</script>
{% endblock %}